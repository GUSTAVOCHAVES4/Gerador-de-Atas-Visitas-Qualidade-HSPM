<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Atas de Avaliação CQH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-4xl mx-auto bg-gray-50 rounded-lg shadow-lg p-6 md:p-12 mb-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Gerador de Atas de Avaliação CQH</h1>
        <p class="text-center text-gray-600 mb-8">Preencha os campos para gerar automaticamente a ata da avaliação.</p>
        <p id="user-id" class="text-center text-xs text-blue-500 mb-4"></p>
        
        <div class="flex items-center gap-4 mb-6" id="filter-container">
            <label for="responsible-filter" class="text-gray-700 font-medium whitespace-nowrap">Filtrar por Responsável:</label>
            <select id="responsible-filter" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white shadow-sm">
                <!-- Opções serão adicionadas dinamicamente via JS -->
            </select>
        </div>

        <div id="evaluation-form" class="space-y-6">
            <!-- Dynamic form fields will be injected here by JavaScript -->
        </div>

        <div class="mt-8 text-center flex flex-col md:flex-row justify-center gap-4">
            <button id="generate-button" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
                Gerar Ata de Avaliação
            </button>
            <button id="download-button" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105">
                Baixar Ata (Word)
            </button>
            <button id="generate-action-plan-button" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 transform hover:scale-105">
                Gerar Plano de Ação ✨
            </button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Ata Gerada</h2>
        <div id="minutes-output" class="bg-gray-200 p-4 rounded-lg">
            <p class="text-gray-500 text-center">A ata será gerada aqui após você preencher as informações e clicar no botão acima.</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mt-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Sugestões de Plano de Ação</h2>
        <div id="ai-suggestions-output" class="bg-gray-200 p-4 rounded-lg">
            <p class="text-gray-500 text-center">As sugestões de plano de ação serão exibidas aqui após a geração.</p>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais do ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Dados de exemplo baseados nos arquivos enviados.
        // Se um item tiver múltiplos responsáveis, separe-os com vírgula (ex: "Qualidade, Superintendência").
        // Adicionada a propriedade `theme` para agrupar os itens por temas dentro de cada Fundamento.
        const evaluationData = {
            "1. Pensamento Sistêmico": [
                { id: "pensamentosis_1", section: "1. Pensamento Sistêmico", description: "Modelo de negócio (modelo de atuação da organização, incluindo a cadeia de valor, com destaque para clientes, principais processos, processos de apoio, fornecedores, órgãos reguladores, concorrentes)", itemNumber: "1", exigencyLevel: "*", responsible: "Qualidade", field: "select" }
            ],

            "2. Compromisso com as Partes Interessadas": [
                { id: "partesinter_1", section: "2. Compromisso com as Partes Interessadas", theme: "Cliente", description: "Levantamento do perfil demográfico de seus clientes", itemNumber: "1", exigencyLevel: "", responsible: "NEPI", field: "select" },
                { id: "partesinter_2", section: "2. Compromisso com as Partes Interessadas", theme: "Cliente", description: "Análise do perfil nosológico de seus clientes", itemNumber: "2", exigencyLevel: "*", responsible: "NEPI, DAS", field: "select" },
                { id: "partesinter_3", section: "2. Compromisso com as Partes Interessadas", theme: "Cliente", description: "Manifestações dos clientes na Ouvidoria ou Pesquisa de Satisfação do Cliente ou Manifestações no Serviço de Atendimento ao Cliente (SAC), 0800, Internet ou quaisquer outros canais de comunicação com clientes", itemNumber: "3", exigencyLevel: "", responsible: "OUVIDORIA, QUALIDADE", field: "select" },
                { id: "partesinter_4", section: "2. Compromisso com as Partes Interessadas", theme: "Força de Trabalho", description: "Competências (conhecimentos, habilidades e atitudes) e responsabilidades (autonomia e tarefas atribuídas) na estrutura de cargos", itemNumber: "4", exigencyLevel: "**", responsible: "DGT", field: "select" },
                { id: "partesinter_5", section: "2. Compromisso com as Partes Interessadas", theme: "Força de Trabalho", description: "Programa de Gestão de Risco (PGR) e Programa de Controle Médico de Saúde Ocupacional (PCMSO)", itemNumber: "5", exigencyLevel: "*", responsible: "DGT, NEST", field: "select" },





            ],

            "Fundamento 7 - Orientação por Processos": [
                { id: "f7_1", section: "Fundamento 7 - Orientação por Processos", theme: "Informações Organizacionais", description: "Promove a coleta das informações relevantes sobre os processos principais e de apoio, para avaliação dos resultados?", itemNumber: "1", exigencyLevel: "**", responsible: "NEPI", field: "select" },
                { id: "f7_2", section: "Fundamento 7 - Orientação por Processos", theme: "Gestão por Processos", description: "Há um carrinho de anestesia completo para cada sala de cirurgia?", itemNumber: "39", exigencyLevel: "*", responsible: "Centro Cirúrgico, Anestesia", field: "select" },
                { id: "f7_3", section: "Fundamento 7 - Orientação por Processos", theme: "Apoio Hospitalar", description: "A limpeza diária é supervisionada em todas as unidades?", itemNumber: "168", exigencyLevel: "", responsible: "Higiene e Limpeza", field: "select" },
            ]
        };

        const state = {
            userId: '',
            data: {},
            lastUpdated: null,
            currentFilter: 'Todos'
        };

        window.addEventListener('load', async () => {
            await authenticate();
            setupFilters();
            setupUI();
            startRealtimeListener();
            document.getElementById('generate-button').addEventListener('click', generateMinutes);
            document.getElementById('generate-action-plan-button').addEventListener('click', generateActionPlan);
            document.getElementById('download-button').addEventListener('click', downloadMinutesAsDoc);
        });

        async function authenticate() {
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Erro ao autenticar com token:", error);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
            state.userId = auth.currentUser.uid;
            document.getElementById('user-id').textContent = `ID do Usuário: ${state.userId}`;
        }

        function setupFilters() {
            const selectFilter = document.getElementById('responsible-filter');
            
            selectFilter.addEventListener('change', (e) => {
                state.currentFilter = e.target.value;
                setupUI();
                populateUI(state.data);
            });

            populateResponsibleFilter();
        }

        function populateResponsibleFilter() {
            const responsibles = new Set();
            Object.values(evaluationData).forEach(section => {
                section.forEach(item => {
                    if (item.responsible) {
                        item.responsible.split(',').forEach(name => {
                            const trimmedName = name.trim();
                            if (trimmedName) {
                                responsibles.add(trimmedName);
                            }
                        });
                    }
                });
            });

            const selectFilter = document.getElementById('responsible-filter');
            selectFilter.innerHTML = '';
            
            const allOption = document.createElement('option');
            allOption.value = 'Todos';
            allOption.textContent = 'Todos os Responsáveis';
            selectFilter.appendChild(allOption);

            Array.from(responsibles).sort().forEach(responsible => {
                const option = document.createElement('option');
                option.value = responsible;
                option.textContent = responsible;
                selectFilter.appendChild(option);
            });

            selectFilter.value = state.currentFilter;
        }


        function setupUI() {
            const container = document.getElementById('evaluation-form');
            container.innerHTML = ''; // Limpa o formulário para recriá-lo
            
            let lastSection = null;
            let lastTheme = null;
            let currentSectionDiv = null;
            let currentThemeDiv = null;

            Object.keys(evaluationData).forEach(key => {
                const sectionData = evaluationData[key];
                const filteredSectionData = sectionData.filter(item => {
                    if (state.currentFilter === 'Todos') {
                        return true;
                    }
                    if (item.responsible) {
                        const responsibleList = item.responsible.split(',').map(s => s.trim().toLowerCase());
                        return responsibleList.includes(state.currentFilter.toLowerCase());
                    }
                    return false;
                });

                if (filteredSectionData.length > 0) {
                    filteredSectionData.forEach(item => {
                        // Create section header if different from the last one
                        if (item.section !== lastSection) {
                            currentSectionDiv = document.createElement('div');
                            currentSectionDiv.className = 'mb-6 p-4 bg-white rounded-lg shadow-sm';
                            const sectionTitle = document.createElement('h3');
                            sectionTitle.className = 'text-lg font-semibold mb-4 text-gray-700';
                            sectionTitle.textContent = item.section;
                            currentSectionDiv.appendChild(sectionTitle);
                            container.appendChild(currentSectionDiv);
                            lastSection = item.section;
                            lastTheme = null; // Reset theme for the new section
                        }

                        // Create theme header if different from the last one
                        if (item.theme && item.theme !== lastTheme) {
                            currentThemeDiv = document.createElement('div');
                            currentThemeDiv.className = 'mb-4 pl-4 border-l-4 border-gray-400';
                            const themeTitle = document.createElement('h4');
                            themeTitle.className = 'text-md font-medium text-gray-800';
                            themeTitle.textContent = `Tema: ${item.theme}`;
                            currentThemeDiv.appendChild(themeTitle);
                            currentSectionDiv.appendChild(currentThemeDiv);
                            lastTheme = item.theme;
                        }

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'mb-4 border-b border-gray-200 pb-4';

                        const descriptionParagraph = document.createElement('p');
                        descriptionParagraph.className = 'font-medium text-gray-900';
                        descriptionParagraph.textContent = `Item ${item.itemNumber} ${item.exigencyLevel}: ${item.description}`;
                        itemDiv.appendChild(descriptionParagraph);

                        const responsibleSpan = document.createElement('span');
                        responsibleSpan.className = 'text-sm text-gray-500 italic';
                        if (item.responsible) {
                            responsibleSpan.textContent = `Responsável(is): ${item.responsible}`;
                        } else {
                            responsibleSpan.textContent = ``;
                        }
                        itemDiv.appendChild(responsibleSpan);


                        const inputContainer = document.createElement('div');
                        inputContainer.className = 'mt-2 flex flex-col md:flex-row md:items-center gap-4';

                        if (item.field === 'select') {
                            const select = document.createElement('select');
                            select.id = `input-${item.id}`;
                            select.className = 'w-full md:w-auto px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
                            ['', 'SIM', 'NÃO', 'NA'].forEach(optionValue => {
                                const option = document.createElement('option');
                                option.value = optionValue;
                                option.textContent = optionValue || 'Selecione';
                                select.appendChild(option);
                            });
                            select.addEventListener('change', () => updateState(item.id, select.value));
                            inputContainer.appendChild(select);
                        } else if (item.field === 'input') {
                            const input = document.createElement('input');
                            input.id = `input-${item.id}`;
                            input.type = item.type;
                            input.className = 'w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
                            input.addEventListener('input', (e) => updateState(item.id, e.target.value));
                            inputContainer.appendChild(input);
                        } else if (item.field === 'textarea') {
                             const textarea = document.createElement('textarea');
                             textarea.id = `input-${item.id}`;
                             textarea.rows = 4;
                             textarea.className = 'w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
                             textarea.addEventListener('input', (e) => updateState(item.id, e.target.value));
                             inputContainer.appendChild(textarea);
                        }
                        
                        // Campos separados para Evidências, Propostas e Observações
                        if (item.field === 'select') {
                            const evidenceTextarea = document.createElement('textarea');
                            evidenceTextarea.id = `evidence-${item.id}`;
                            evidenceTextarea.placeholder = 'Evidências...';
                            evidenceTextarea.rows = 2;
                            evidenceTextarea.className = 'w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2';
                            evidenceTextarea.addEventListener('input', (e) => updateState(`evidence-${item.id}`, e.target.value));
                            inputContainer.appendChild(evidenceTextarea);

                            const proposalsTextarea = document.createElement('textarea');
                            proposalsTextarea.id = `proposals-${item.id}`;
                            proposalsTextarea.placeholder = 'Propostas...';
                            proposalsTextarea.rows = 2;
                            proposalsTextarea.className = 'w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2';
                            proposalsTextarea.addEventListener('input', (e) => updateState(`proposals-${item.id}`, e.target.value));
                            inputContainer.appendChild(proposalsTextarea);

                            const observationTextarea = document.createElement('textarea');
                            observationTextarea.id = `obs-${item.id}`;
                            observationTextarea.placeholder = 'Observações...';
                            observationTextarea.rows = 2;
                            observationTextarea.className = 'w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2';
                            observationTextarea.addEventListener('input', (e) => updateState(`obs-${item.id}`, e.target.value));
                            inputContainer.appendChild(observationTextarea);
                        }

                        itemDiv.appendChild(inputContainer);
                        // Append to the current theme div or section div
                        if (currentThemeDiv) {
                            currentThemeDiv.appendChild(itemDiv);
                        } else {
                            currentSectionDiv.appendChild(itemDiv);
                        }
                    });
                }
            });
        }

        async function updateState(id, value) {
            state.data[id] = value;
            await saveToFirestore();
        }

        async function saveToFirestore() {
            if (!state.userId) {
                console.error("Usuário não autenticado. Não é possível salvar.");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${state.userId}/avaliacao/ata`);
                await setDoc(docRef, {
                    ...state.data,
                    lastUpdated: serverTimestamp()
                });
                console.log("Dados salvos com sucesso!");
            } catch (e) {
                console.error("Erro ao salvar dados: ", e);
            }
        }

        function startRealtimeListener() {
            if (!state.userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${state.userId}/avaliacao/ata`);
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    state.data = data;
                    populateUI(data);
                }
            }, (error) => {
                console.error("Erro ao receber updates em tempo real: ", error);
            });
        }

        function populateUI(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(`input-${key}`) || document.getElementById(`obs-${key}`) || document.getElementById(`evidence-${key}`) || document.getElementById(`proposals-${key}`);
                if (element) {
                    if (element.tagName === 'SELECT' || element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.value = data[key] || '';
                    }
                }
            });
        }

        function generateMinutes() {
            const yesItems = [];
            const noItems = [];
            const naItems = [];
            const observationDetails = [];
            const tableData = [];

            const allItems = Object.values(evaluationData).flat();

            allItems.forEach(item => {
                const value = state.data[item.id];
                const obs = state.data[`obs-${item.id}`];
                const evidence = state.data[`evidence-${item.id}`];
                const proposals = state.data[`proposals-${item.id}`];
                
                tableData.push({
                    itemNumber: item.itemNumber,
                    theme: item.theme,
                    exigencyLevel: item.exigencyLevel,
                    description: item.description,
                    responsible: item.responsible || 'Não definido',
                    status: value || '',
                });

                if (value === 'SIM') {
                    yesItems.push(item);
                } else if (value === 'NÃO') {
                    noItems.push(item);
                    if (evidence || proposals || obs) {
                        observationDetails.push({ 
                            item, 
                            evidence, 
                            proposals, 
                            obs 
                        });
                    }
                } else if (value === 'NA') {
                     naItems.push(item);
                     if (evidence || proposals || obs) {
                        observationDetails.push({
                            item,
                            evidence,
                            proposals,
                            obs
                        });
                     }
                }
            });

            const hospitalName = state.data['info_geral_2'] || 'Hospital não especificado';
            
            // Generate HTML table for better visuals
            const summaryTableHTML = `
                <table class="w-full text-sm text-left text-gray-700 rounded-lg overflow-hidden border border-gray-300">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                        <tr>
                            <th scope="col" class="px-6 py-3 border-r border-gray-300">#</th>
                            <th scope="col" class="px-6 py-3 border-r border-gray-300">Tema</th>
                            <th scope="col" class="px-6 py-3 border-r border-gray-300">Ação</th>
                            <th scope="col" class="px-6 py-3 border-r border-gray-300">Responsável</th>
                            <th scope="col" class="px-6 py-3 text-center border-r border-gray-300">SIM</th>
                            <th scope="col" class="px-6 py-3 text-center border-r border-gray-300">NÃO</th>
                            <th scope="col" class="px-6 py-3 text-center">NA</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableData.map(item => `
                            <tr class="bg-white border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap border-r border-gray-200">${item.itemNumber} ${item.exigencyLevel}</td>
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-pre-wrap border-r border-gray-200">${item.theme || ''}</td>
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-pre-wrap border-r border-gray-200">${item.description}</td>
                                <td class="px-6 py-4 whitespace-nowrap border-r border-gray-200">${item.responsible}</td>
                                <td class="px-6 py-4 text-center border-r border-gray-200">${item.status === 'SIM' ? 'X' : ''}</td>
                                <td class="px-6 py-4 text-center border-r border-gray-200">${item.status === 'NÃO' ? 'X' : ''}</td>
                                <td class="px-6 py-4 text-center">${item.status === 'NA' ? 'X' : ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            let minutesText = `
## Ata de Reunião de Avaliação - ${hospitalName}
* **Data:** ${new Date().toLocaleDateString('pt-BR')}
* **Avaliador(es):** ${state.userId}
* **Assunto:** Avaliação baseada no Roteiro CQH-006 rev14.

---

### 1. Resumo dos Resultados
* **Itens Avaliados com SIM:** ${yesItems.length}
* **Itens Avaliados com NÃO:** ${noItems.length}
* **Itens Avaliados com NA:** ${naItems.length}

### 2. Quadro de Avaliação
${summaryTableHTML}

### 3. Evidências, Propostas e Observações

${observationDetails.length > 0 ? observationDetails.map(data => `
**Item: ${data.item.itemNumber} ${data.item.exigencyLevel}: ${data.item.description}**
${data.evidence ? `**Evidências:**\n- ${data.evidence}` : ''}
${data.proposals ? `**Propostas:**\n- ${data.proposals}` : ''}
${data.obs ? `**Observações:**\n- ${data.obs}` : ''}
`).join('\n\n') : '*Nenhuma evidência, proposta ou observação registrada.*'}

---

### 4. Plano de Ação (Sugestão)
- **Ações:** Elaborar um plano de ação detalhado para os itens marcados como "NÃO", com responsáveis e prazos definidos.
- **Próximos Passos:** Agendar reunião para a definição das melhorias.

**Ata gerada automaticamente. Por favor, revise para garantir a precisão.**
            `;
            document.getElementById('minutes-output').innerHTML = `
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner mt-8">
                    <pre class="whitespace-pre-wrap text-sm text-gray-800">${minutesText}</pre>
                </div>
            `;
        }
        
        function downloadMinutesAsDoc() {
            const minutesOutput = document.getElementById('minutes-output');
            const content = minutesOutput.innerHTML;
            const filename = `ata_avaliacao_${new Date().toISOString().slice(0, 10)}.doc`;

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Ata de Reunião de Avaliação</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; line-height: 1.6; padding: 20px; }
                        h1, h2, h3 { color: #1f2937; margin-top: 2rem; margin-bottom: 1rem; }
                        h1 { font-size: 2.25rem; font-weight: bold; text-align: center; }
                        h2 { font-size: 1.875rem; font-weight: bold; }
                        h3 { font-size: 1.5rem; font-weight: bold; }
                        p { margin-bottom: 1rem; }
                        ul { margin-bottom: 1rem; padding-left: 20px; }
                        li { list-style-type: disc; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; border: 1px solid #d1d5db; }
                        th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: left; }
                        th { background-color: #f3f4f6; font-weight: 700; text-transform: uppercase; }
                        pre { white-space: pre-wrap; font-size: 0.875rem; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function generateActionPlan() {
            const noItems = [];
            const allItems = Object.values(evaluationData).flat();
            allItems.forEach(item => {
                const value = state.data[item.id];
                const obs = state.data[`obs-${item.id}`];
                const evidence = state.data[`evidence-${item.id}`];
                const proposals = state.data[`proposals-${item.id}`];
                const responsible = item.responsible || 'Não definido';
                if (value === 'NÃO') {
                    noItems.push({ 
                        section: item.section,
                        description: item.description,
                        responsible: responsible,
                        evidence: evidence,
                        proposals: proposals,
                        observation: obs
                    });
                }
            });

            if (noItems.length === 0) {
                document.getElementById('ai-suggestions-output').innerHTML = `<p class="text-gray-500 text-center">Nenhum item marcado como "NÃO" para gerar sugestões de plano de ação.</p>`;
                return;
            }

            document.getElementById('ai-suggestions-output').innerHTML = `<div class="flex items-center justify-center p-4 text-blue-500"><svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p>Gerando sugestões de plano de ação...</p></div>`;

            const promptText = `
                Atue como um consultor de gestão de qualidade e segurança do paciente em hospitais. 
                Sua tarefa é analisar os seguintes itens que falharam em uma auditoria de avaliação hospitalar e fornecer um plano de ação detalhado para cada um. Para cada item, identifique o problema, liste os passos sugeridos para a resolução (com foco em ação, responsabilidade e prazo), e destaque os benefícios de corrigir a falha.
                
                Aqui estão os itens:
                ${JSON.stringify(noItems, null, 2)}
            `;

            const payload = {
                contents: [{ parts: [{ text: promptText }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "Você é um consultor especializado em gestão hospitalar. Responda com um plano de ação claro e direto, utilizando uma linguagem técnica e profissional. Responda apenas com o texto do plano de ação." }]
                },
            };
            const apiKey = ""
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Não foi possível gerar sugestões de plano de ação.";
                
                document.getElementById('ai-suggestions-output').innerHTML = `
                    <div class="bg-gray-50 p-6 rounded-lg shadow-inner mt-8">
                        <pre class="whitespace-pre-wrap text-sm text-gray-800">${generatedText}</pre>
                    </div>
                `;

            } catch (error) {
                console.error("Erro na chamada da API:", error);
                document.getElementById('ai-suggestions-output').innerHTML = `<p class="text-red-500 text-center">Ocorreu um erro ao gerar o plano de ação. Tente novamente.</p>`;
            }
        }
    </script>
</body>
</html>